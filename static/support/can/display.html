
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Candlesticks test</title>

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script src="new/highstock.js"></script>
<script src="new/exporting.js"></script>
<script src="indicators_ui_logic.js"></script>

	<script>
	
	parentwin=window.opener!=null?window.opener:top;	
	
arrayUnique = function(a) {
    return a.reduce(function(p, c) {
        if (p.indexOf(c) < 0) p.push(c);
        return p;
    }, []);
};

window["vertpanesno"]=0;

function defarr2axes() {
	var ret=[];
	uniques=arrayUnique(defarr.map(function(x){return x.index}));
	for (var ea in uniques) {
			ret.push({index:uniques[ea],nam: defarr.filter(function(y){return (y.index==uniques[ea])}).map(function(x){return x.nam}).join(" ") });
		} // bonus points for redoing this loop with a .map call
	return ret;
	}


function indexDef(obj) {
    var top, height;
    var totalitems = arrayUnique(defarr.map(function(x) {return(x.index) })).length;
    var addtlitems = totalitems - 1;
    var addtlh = 45 / addtlitems;
    if (obj.index == 1) {
        top = "0%";
        height=totalitems>1?"50%":"100%";
    }
    else {
        top = (55 + (obj.index - 2) * addtlh) + "%";
        height = (45 / (totalitems - 1)) + "%";
    }
    return ({
        labels: {
            align: 'right',
            x: -3
        },
        title: {
            text: obj.nam
        },
        top: top,
        height: height,
        offset: 0,
        lineWidth: 2
    });
}

function dataDef(obj) {
    var type;
    if (obj.dat[0].length > 4) { // se nam contiene OHLC! oppure se ci sono almeno 5 elementi in obj.dat[0].length
        type = "candlestick"
    }
    else {
        type = "line"
    }
    return ({
        type: type,
        name: obj.nam,
        data: obj.dat,
        yAxis: (obj.index-1)
    });
}

    
    var winarr  = (parentwin != null) ? parentwin.extwindows : top.extwindows; 
    thiswinidx=-1;
    for (ea in winarr) {
        if (winarr[ea]["wref"] == this.window) {
            console.log("ur data arr is:"+winarr[ea])
            datarr = winarr[ea]["datarr"];
            title = winarr[ea]["title"];
            // old code above, new below
            defarr = winarr[ea]["datas"];
            defobj = winarr[ea];
            if (typeof defobj["tamodels"] == "undefined") { defobj["tamodels"] =[]; }
            window.document.title = title;
            thiswinidx = ea; // you should really be using a unique autogenerated id...
            /*
            if (winarr[ea]["datas"]) {
                for (var si in winarr[ea]["datas"]) {
                    console.log("found dataseries:",winarr[ea]["datas"][si]);
                    
                }    
            }*/
            
        }
    } // could use .filter if you were feeling stylish
    
    
    console.log(datarr);
    
    isNumber = function(n) {
    return !isNaN(parseFloat(n)) && isFinite(n);
}
    
    // next version ... iterate over winarr[ea]["datas"], coount how many different idxs  there r, create axes and series as necessary
    myData=datarr;dctr=0;
	</script>
	
	
</head>
<style>
#container,#optsdiv {
    height:100%;
    width:100%;
    position:absolute;
}
table {width:100%;}
td {border-bottom:solid 1px gray;max-width:222px;}
</style>
<body style="padding:0px;margin:0px;" onload="cdlinit()">
<div id="confdiv" style="font-size:12px;font-family:verdana:display:none;z-index:9001">
</div>
<div id="optsdiv" style="font-size:12px;font-family:verdana">
<input type="button" onclick="back2display()" value="Save and show chart." style="width:100%">

</div>
<div id="container" style="min-width: 500px"></div>

<script>

/* obj example:

{"PROVA":[{"args":["50","2","2","1"],"targseridx":0,"funname":"_fBBANDS","destinationaxis":1},{"args":["14"],"targseridx":0,"funname":"_fROC","destinationaxis":2},{"args":["14"],"targseridx":0,"funname":"_fATR","destinationaxis":3}]}

*/

 
back2display = function(){document.getElementById("optsdiv").style.display="none"; document.getElementById("container").style.display="block";}

addthis = function(w){
    //console.log(w.name);
    var prefix = (w.name.replace("c_TA_","o_TA_"));
    var funname=(w.name.replace("c_TA_","_f"));
    //console.log("FUNNAME",funname);
    
    var tapars={funname:funname};
    var argarr=[];
    var modelargs=[];
    var modelobj={};
    var targseridx;
    var destinationaxis;
    
    console.log( funname , parentwin[funname].length  );
    var optpars={};
    allinputs=document.querySelectorAll("input");
    for (var ea in allinputs) {
        if (allinputs[ea].name) {if (allinputs[ea].name.indexOf(w.name.replace("c_","o_") )==0) { 
            console.log ( allinputs[ea].name.replace(prefix,"$optIn") , allinputs[ea].value    ) ;
            tapars[ allinputs[ea].name.replace(prefix,"$optIn") ]= allinputs[ea].value   ;
            } }
    }
    allselects=document.querySelectorAll("select");
    for (var ea in allselects) {
        if (allselects[ea].name) {if (allselects[ea].name.indexOf(w.name.replace("c_","s_") )==0) { 
            //console.log ( allselects[ea].name , allselects[ea].value    ) 
            //console.log( "which is" , nam2axisobj(allselects[ea].value) )
            //if (allselects[ea].name.indexOf("_toAxis")>-1) {console.log ( "TOAXIS" , allselects[ea].value    );destinationaxis=allselects[ea].value=="own"?(window["vertpanesno"]+1):nam2axisobj(allselects[ea].value).index;  } 
            if (allselects[ea].name.indexOf("_toAxis")>-1) {console.log ( "TOAXIS" , allselects[ea].value    );destinationaxis=allselects[ea].value=="own"?(window["vertpanesno"]+1):Number(allselects[ea].value);  } 
            // TODO : vertpanesno is incorrectly calced
            if (allselects[ea].name.indexOf("_onSeries")>-1) {targseridx=Number(allselects[ea].value); console.log ( "ONseries" , allselects[ea].value ) ; } 
            } }
    }
    
    var fdefarr=pobj[(w.name.replace("c_TA_","o_TA_"))];
    console.log(fdefarr); 
    
    var seriesInTarget= index2axisobj(+Number(targseridx)+Number(1)).dat[0].length;

    console.log("seriesInTarget:",seriesInTarget);
    
    var outs=0;
    for (var e in fdefarr) {
        if (fdefarr[e].indexOf("$out")==-1) {
            //rimane da gestire gli in.
            
            if (fdefarr[e].indexOf("$in")==0) {
                if (fdefarr[e]=="$inReal" || fdefarr[e]=="$inClose") {  if (seriesInTarget>=4) { argarr.push(parentwin.Transpose(index2axisobj(targseridx+1).dat)[4]) } else { argarr.push(parentwin.Transpose(index2axisobj(targseridx+1).dat)[1]) }  } 
                if (fdefarr[e]=="$inOpen") {  if (seriesInTarget>=4) { argarr.push(parentwin.Transpose(index2axisobj(targseridx+1).dat)[1]) } else { argarr.push(parentwin.Transpose(index2axisobj(targseridx+1).dat)[1]) }  }
                if (fdefarr[e]=="$inHigh") {  if (seriesInTarget>=4) { argarr.push(parentwin.Transpose(index2axisobj(targseridx+1).dat)[2]) } else { argarr.push(parentwin.Transpose(index2axisobj(targseridx+1).dat)[1]) }  } 
                if (fdefarr[e]=="$inLow") {  if (seriesInTarget>=4) { argarr.push(parentwin.Transpose(index2axisobj(targseridx+1).dat)[3]) } else { argarr.push(parentwin.Transpose(index2axisobj(targseridx+1).dat)[1]) }  } 
            }


            if (fdefarr[e].indexOf("$optIn")>-1) {
                argarr.push(tapars[fdefarr[e]]);
                modelargs.push(tapars[fdefarr[e]]);
            }
            
            
        }
        else { if (  (fdefarr[e].indexOf("$outBegIdx")==-1)    &&    (fdefarr[e].indexOf("$outNBElement")==-1)      )  {outs++;  }   }
    }
    
    console.log(argarr);
    modelobj["seriesindex"]=chart1.series.map(function(x){return [x.index,x.name]}).length; // map is useless here
    modelobj["args"]=modelargs;
    modelobj["targseridx"]=targseridx; // +1 maybe
    modelobj["funname"]=funname;
    modelobj["destinationaxis"]=destinationaxis;
    console.log(modelobj);
    console.log(defobj);
    defobj.tamodels.push(modelobj);

    giornis=parentwin.Transpose(index2axisobj(1).dat)[0];
    //console.log("giornis:",giornis);   
    NEWSERIESDATA=parentwin[funname].apply(this,argarr);
    if (outs == 1) {
        NEWDATAARRAY = parentwin.Transpose([giornis, NEWSERIESDATA]);
        defarr.push({dat:NEWDATAARRAY,nam:funname.replace("_f",""),index:destinationaxis});
        console.log(NEWDATAARRAY);
        window.location.reload(); // TODO: use addseries
    }
    else {
        console.log("more than one out, do something");
        console.log(NEWSERIESDATA);
        for (var ee in NEWSERIESDATA) {
            NEWDATAARRAY = parentwin.Transpose([giornis, NEWSERIESDATA[ee]]); 
            defarr.push({dat:NEWDATAARRAY,nam:funname.replace("_f","")+ee,index:destinationaxis});
            window.location.reload(); // TODO: this can prolly be avoided ANS SHOULD DEFINITELY BE OUTSIDE THIS LOOP TODO: TODO:
        }
        // sticha giornis ad ognuno di essi ed adda ogni risultato come serie nuova sull√¨ index esistente
    }
    // NO DEVI CONTROLLARE QUANTI out ci sono , cosi' va bene solo per 1 out.. fai un for each su NEWSERIESDATA
    // sei fortunello solo BBANDS ha piu' di un output...
    // aggiungi NEWDATAARRAY alla chart, o in un nuovo asse o meno ma aggiungilo e poi chiama redraw
    }

indmenu=[{text:'ADXR',onclick:function(){addTA('ADXR')}},{text:'ADX',onclick:function(){addTA('ADX')}},{text:'AROONOSC',onclick:function(){addTA('AROONOSC')}},{text:'ATR',onclick:function(){addTA('ATR')}},{text:'AVGDEV',onclick:function(){addTA('AVGDEV')}},{text:'BBANDS',onclick:function(){addTA('BBANDS')}},{text:'CCI',onclick:function(){addTA('CCI')}},{text:'CMO',onclick:function(){addTA('CMO')}},{text:'DX',onclick:function(){addTA('DX')}},{text:'LINEARREG_ANGLE',onclick:function(){addTA('LINEARREG_ANGLE')}},{text:'LINEARREG_INTERCEPT',onclick:function(){addTA('LINEARREG_INTERCEPT')}},{text:'LINEARREG_SLOPE',onclick:function(){addTA('LINEARREG_SLOPE')}},{text:'LINEARREG',onclick:function(){addTA('LINEARREG')}},{text:'MACD',onclick:function(){addTA('MACD')}},{text:'MAX',onclick:function(){addTA('MAX')}},{text:'MIDPOINT',onclick:function(){addTA('MIDPOINT')}},{text:'MIDPRICE',onclick:function(){addTA('MIDPRICE')}},{text:'MIN',onclick:function(){addTA('MIN')}},{text:'MINUS_DI',onclick:function(){addTA('MINUS_DI')}},{text:'MINUS_DM',onclick:function(){addTA('MINUS_DM')}},{text:'MOM',onclick:function(){addTA('MOM')}},{text:'NATR',onclick:function(){addTA('NATR')}},{text:'PLUS_DI',onclick:function(){addTA('PLUS_DI')}},{text:'PLUS_DM',onclick:function(){addTA('PLUS_DM')}},{text:'ROCP',onclick:function(){addTA('ROCP')}},{text:'ROCR100',onclick:function(){addTA('ROCR100')}},{text:'ROCR',onclick:function(){addTA('ROCR')}},{text:'ROC',onclick:function(){addTA('ROC')}},{text:'RSI',onclick:function(){addTA('RSI')}},{text:'STDDEV',onclick:function(){addTA('STDDEV')}},{text:'TRIX',onclick:function(){addTA('TRIX')}},{text:'TSF',onclick:function(){addTA('TSF')}},{text:'VAR',onclick:function(){addTA('VAR')}},{text:'WILLR',onclick:function(){addTA('WILLR')}}];
funmenu=[{text:'ADD',onclick:function(){addTA('ADD')}},{text:'BETA',onclick:function(){addTA('BETA')}},{text:'CORREL',onclick:function(){addTA('CORREL')}},{text:'DIV',onclick:function(){addTA('DIV')}},{text:'SUM',onclick:function(){addTA('SUM')}},{text:'SUB',onclick:function(){addTA('SUB')}},{text:'MULT',onclick:function(){addTA('MULT')}}];
avgmenu=[{text:'DEMA',onclick:function(){addTA('DEMA')}},{text:'DIV',onclick:function(){addTA('DIV')}},{text:'DX',onclick:function(){addTA('DX')}},{text:'EMA',onclick:function(){addTA('EMA')}},{text:'KAMA',onclick:function(){addTA('KAMA')}},{text:'SMA',onclick:function(){addTA('SMA')}},{text:'TEMA',onclick:function(){addTA('TEMA')}},{text:'TRIMA',onclick:function(){addTA('TRIMA')}},{text:'WMA',onclick:function(){addTA('WMA')}},{text:'MA',onclick:function(){addTA('MA')}}];
cdlmenu=[{text:'CDL2CROWS',onclick:function(){addTA('CDL2CROWS')}},{text:'CDL3BLACKCROWS',onclick:function(){addTA('CDL3BLACKCROWS')}},{text:'CDL3INSIDE',onclick:function(){addTA('CDL3INSIDE')}},{text:'CDL3LINESTRIKE',onclick:function(){addTA('CDL3LINESTRIKE')}},{text:'CDL3OUTSIDE',onclick:function(){addTA('CDL3OUTSIDE')}},{text:'CDL3STARSINSOUTH',onclick:function(){addTA('CDL3STARSINSOUTH')}},{text:'CDL3WHITESOLDIERS',onclick:function(){addTA('CDL3WHITESOLDIERS')}},{text:'CDLADVANCEBLOCK',onclick:function(){addTA('CDLADVANCEBLOCK')}},{text:'CDLBELTHOLD',onclick:function(){addTA('CDLBELTHOLD')}},{text:'CDLBREAKAWAY',onclick:function(){addTA('CDLBREAKAWAY')}},{text:'CDLCLOSINGMARUBOZU',onclick:function(){addTA('CDLCLOSINGMARUBOZU')}},{text:'CDLCONCEALBABYSWALL',onclick:function(){addTA('CDLCONCEALBABYSWALL')}},{text:'CDLCOUNTERATTACK',onclick:function(){addTA('CDLCOUNTERATTACK')}},{text:'CDLDOJISTAR',onclick:function(){addTA('CDLDOJISTAR')}},{text:'CDLDOJI',onclick:function(){addTA('CDLDOJI')}},{text:'CDLDRAGONFLYDOJI',onclick:function(){addTA('CDLDRAGONFLYDOJI')}},{text:'CDLENGULFING',onclick:function(){addTA('CDLENGULFING')}},{text:'CDLGAPSIDESIDEWHITE',onclick:function(){addTA('CDLGAPSIDESIDEWHITE')}},{text:'CDLGRAVESTONEDOJI',onclick:function(){addTA('CDLGRAVESTONEDOJI')}},{text:'CDLHAMMER',onclick:function(){addTA('CDLHAMMER')}},{text:'CDLHANGINGMAN',onclick:function(){addTA('CDLHANGINGMAN')}},{text:'CDLHARAMICROSS',onclick:function(){addTA('CDLHARAMICROSS')}},{text:'CDLHARAMI',onclick:function(){addTA('CDLHARAMI')}},{text:'CDLHIGHWAVE',onclick:function(){addTA('CDLHIGHWAVE')}},{text:'CDLHIKKAKEMOD',onclick:function(){addTA('CDLHIKKAKEMOD')}},{text:'CDLHIKKAKE',onclick:function(){addTA('CDLHIKKAKE')}},{text:'CDLHOMINGPIGEON',onclick:function(){addTA('CDLHOMINGPIGEON')}},{text:'CDLIDENTICAL3CROWS',onclick:function(){addTA('CDLIDENTICAL3CROWS')}},{text:'CDLINNECK',onclick:function(){addTA('CDLINNECK')}},{text:'CDLINVERTEDHAMMER',onclick:function(){addTA('CDLINVERTEDHAMMER')}},{text:'CDLKICKINGBYLENGTH',onclick:function(){addTA('CDLKICKINGBYLENGTH')}},{text:'CDLKICKING',onclick:function(){addTA('CDLKICKING')}},{text:'CDLLADDERBOTTOM',onclick:function(){addTA('CDLLADDERBOTTOM')}},{text:'CDLLONGLEGGEDDOJI',onclick:function(){addTA('CDLLONGLEGGEDDOJI')}},{text:'CDLLONGLINE',onclick:function(){addTA('CDLLONGLINE')}},{text:'CDLMARUBOZU',onclick:function(){addTA('CDLMARUBOZU')}},{text:'CDLMATCHINGLOW',onclick:function(){addTA('CDLMATCHINGLOW')}},{text:'CDLMORNINGSTAR',onclick:function(){addTA('CDLMORNINGSTAR')}},{text:'CDLONNECK',onclick:function(){addTA('CDLONNECK')}},{text:'CDLPIERCING',onclick:function(){addTA('CDLPIERCING')}},{text:'CDLRICKSHAWMAN',onclick:function(){addTA('CDLRICKSHAWMAN')}},{text:'CDLRISEFALL3METHODS',onclick:function(){addTA('CDLRISEFALL3METHODS')}},{text:'CDLSEPARATINGLINES',onclick:function(){addTA('CDLSEPARATINGLINES')}},{text:'CDLSHOOTINGSTAR',onclick:function(){addTA('CDLSHOOTINGSTAR')}},{text:'CDLSHORTLINE',onclick:function(){addTA('CDLSHORTLINE')}},{text:'CDLSPINNINGTOP',onclick:function(){addTA('CDLSPINNINGTOP')}},{text:'CDLSTALLEDPATTERN',onclick:function(){addTA('CDLSTALLEDPATTERN')}},{text:'CDLSTICKSANDWICH',onclick:function(){addTA('CDLSTICKSANDWICH')}},{text:'CDLTAKURI',onclick:function(){addTA('CDLTAKURI')}},{text:'CDLTASUKIGAP',onclick:function(){addTA('CDLTASUKIGAP')}},{text:'CDLTHRUSTING',onclick:function(){addTA('CDLTHRUSTING')}},{text:'CDLTRISTAR',onclick:function(){addTA('CDLTRISTAR')}},{text:'CDLUNIQUE3RIVER',onclick:function(){addTA('CDLUNIQUE3RIVER')}},{text:'CDLUPSIDEGAP2CROWS',onclick:function(){addTA('CDLUPSIDEGAP2CROWS')}}];
// this bisplussuboptimal. use target.textContent instead

function addTA(wha){
    //console.log(wha);alert(taobj[wha]);
    document.getElementById("confdiv").style.display="block";
    document.getElementById("confdiv").innerHTML=taobj[wha];
}

function remconf(){document.getElementById("confdiv").style.display="none";}

function restoreTemplate(w){alert(w);console.log(JSON.parse(localStorage.getItem("TAT_ARR"))[w])}

lsobj2templatemenu = function(){
try{
var ret=[];    
var t=JSON.parse(localStorage.getItem("TAT_ARR"));
for (var e in t) {  ret.push({text:e,onclick:function(a){restoreTemplate(a.target.textContent)}})  }
}
catch(e){}
return ret;
}
   

chart1=new Highcharts.StockChart( {
    chart: {
        renderTo:'container'
    }
    , navigator : {
        enabled : false 
    }
    , exporting: {
        buttons: {
            
            customButton: {
                // target.outerText o target.textContent
                x: -560, menuItems:[{text:"save current",onclick:function(){
                        //console.log(JSON.stringify(defobj.tamodels));
                        if ( localStorage.getItem("TAT_ARR")==null) {localStorage.setItem("TAT_ARR",JSON.stringify({}));}
                        curarch=JSON.parse(localStorage.getItem("TAT_ARR"));
                        var tname=prompt("name?");
                        curarch[tname]=defobj.tamodels;
                        localStorage.setItem("TAT_ARR",JSON.stringify(curarch));
                    }
                },
                {text:"import template",onclick:function(){alert(prompt("template URL?"))}},
                {text:"export template",onclick:function(){alert(prompt("template URL?"))}},
                {text:"test",onclick:function(a,b){console.log(a);console.log(b);alert("not yet available")}},
                {text:"enable navigator",onclick:function(a,b){console.log(a);console.log(b);alert("not yet available")}}
                ].concat(lsobj2templatemenu())
                , symbol:'menu', text:'templates'
            },
            candleButton: {
                x: -300, menuItems:cdlmenu
                , symbol:'menu', text:'patterns'
            },
            moarButton: {
                x: -380, menuItems:indmenu
                , symbol:'menu', text:'indic'
            },
            extrButton: {
                x: -460, menuItems:funmenu.concat(avgmenu)
                , symbol:'menu', text:'avgs & rels'
            }
        }
    },
    rangeSelector: {
        selected: 1
    }
    , series:defarr.map(dataDef)
    , yAxis : defarr2axes().map(indexDef)
}
);


function axes2menu() {
assi=chart1.axes.filter(function(x){return (x.coll=="yAxis" && typeof x.axisTitle == "object")  });
window["vertpanesno"]=arrayUnique(assi.map(function(x){return x.userOptions.index})).length;

//return ( "<option value='own' selected>Own</option>"+  assi.map(function(x){return ("<option value='"+x.axisTitle.textStr+"'>"+x.axisTitle.textStr+"</option>")}).join("")) 
return ( "<option value='own' selected>Own</option>"+  assi.map(function(x){return ("<option value='"+(x.userOptions.index+1)+"'>"+x.axisTitle.textStr+"</option>")}).join("")) 
}
window.amenutxt=axes2menu();
function series2menu() {
return ( chart1.series.map(function(x){return (x.index==0?"<option selected value='0'>"+x.name+"</option>":"<option value='"+x.index+"'>"+x.name+"</option>")}).join("")) 
}
window.smenutxt=series2menu();

index2axisobj=function(i){return (defarr.filter(function(x){return (x.index==i)})[0])     }
nam2axisobj=function(i){return (defarr.filter(function(x){return (x.nam==i)})[0])     } // deletable?



</script>    
    
    
    
</body>
</html>


