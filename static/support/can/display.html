<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Candlesticks test</title>

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script src="new/highstock.js"></script>
<script src="new/exporting.js"></script>
<script src="indicators_ui_logic.js"></script>

	<script>
	
arrayUnique = function(a) {
    return a.reduce(function(p, c) {
        if (p.indexOf(c) < 0) p.push(c);
        return p;
    }, []);
};

window["vertpanesno"]=0;

function indexDef(obj) {
    var top, height;
    var totalitems = arrayUnique(defarr.map(function(x) {return(x.index) })).length;
    var addtlitems = totalitems - 1;
    var addtlh = 45 / addtlitems;
    if (obj.index == 1) {
        top = "0%";
        height=totalitems>1?"50%":"100%";
    }
    else {
        top = (55 + (obj.index - 2) * addtlh) + "%";
        height = (45 / (totalitems - 1)) + "%";
    }
    return ({
        labels: {
            align: 'right',
            x: -3
        },
        title: {
            text: obj.nam
        },
        top: top,
        height: height,
        offset: 0,
        lineWidth: 2
    });
}

function dataDef(obj) {
    var type;
    if (obj.dat[0].length > 4) { // se nam contiene OHLC! oppure se ci sono almeno 5 elementi in obj.dat[0].length
        type = "candlestick"
    }
    else {
        type = "line"
    }
    return ({
        type: type,
        name: obj.nam,
        data: obj.dat,
        yAxis: (obj.index-1)
    });
}

    
    var winarr  = (window.opener != null) ? window.opener.extwindows : top.extwindows; //not really a csv
    thiswinidx=-1;
    for (ea in winarr) {
        if (winarr[ea]["wref"] == this.window) {
            console.log("ur data arr is:"+winarr[ea])
            datarr = winarr[ea]["datarr"];
            title = winarr[ea]["title"];
            // old code above, new below
            defarr = winarr[ea]["datas"];
            window.document.title = title;
            thiswinidx = ea; // you should really be using a unique autogenerated id...
            if (winarr[ea]["datas"]) {
                for (var si in winarr[ea]["datas"]) {
                    console.log("found dataseries:",winarr[ea]["datas"][si]);
                    
                }    
            }
            
        }
    } // could use .filter if you were feeling stylish
    
    
    console.log(datarr);
    
    isNumber = function(n) {
    return !isNaN(parseFloat(n)) && isFinite(n);
}
    
    // next version ... iterate over winarr[ea]["datas"], coount how many different idxs  there r, create axes and series as necessary
    

    myData=datarr;dctr=0;

	//console.log(myData);
	
    // setup the state provider, all state information will be saved to a cookie
    
    

    
	</script>
	
	
</head>
<style>
#container,#optsdiv {
    height:100%;
    width:100%;
    position:absolute;
}
table {width:100%;}
td {border-bottom:solid 1px gray;max-width:222px;}
</style>
<body style="padding:0px;margin:0px;" onload="cdlinit()">
<div id="optsdiv" style="font-size:12px;font-family:verdana">
<input type="button" onclick="back2display()" value="Save and show chart." style="width:100%">

</div>
<div id="container" style="min-width: 500px"></div>

<script>
    
back2display = function(){document.getElementById("optsdiv").style.display="none"; document.getElementById("container").style.display="block";}

addthis = function(w){
    console.log(w.name);
    var prefix = (w.name.replace("c_TA_","o_TA_"));
    var funname=(w.name.replace("c_TA_","_f"));
    console.log("FUNNAME",funname);
    
    var tapars={funname:funname};
    var argarr=[];
    var targseridx;
    var destinationaxis;
    
    giornis=window.opener.Transpose(index2axisobj(1).dat)[0];
    //console.log("giornis:",giornis);
    
    
    console.log( funname , window.opener[funname].length  );
    var optpars={};
    allinputs=document.querySelectorAll("input");
    for (var ea in allinputs) {
        if (allinputs[ea].name) {if (allinputs[ea].name.indexOf(w.name.replace("c_","o_") )==0) { 
            console.log ( allinputs[ea].name.replace(prefix,"$optIn") , allinputs[ea].value    ) ;
            tapars[ allinputs[ea].name.replace(prefix,"$optIn") ]= allinputs[ea].value   ;
            } }
    }
    allselects=document.querySelectorAll("select");
    for (var ea in allselects) {
        if (allselects[ea].name) {if (allselects[ea].name.indexOf(w.name.replace("c_","s_") )==0) { 
            //console.log ( allselects[ea].name , allselects[ea].value    ) 
            //console.log( "which is" , nam2axisobj(allselects[ea].value) )
            if (allselects[ea].name.indexOf("_toAxis")>-1) {console.log ( "TOAXIS" , allselects[ea].value    );destinationaxis=allselects[ea].value=="own"?(window["vertpanesno"]+1):nam2axisobj(allselects[ea].value).index;  } 
            if (allselects[ea].name.indexOf("_onSeries")>-1) {targseridx=allselects[ea].value; console.log ( "ONseries" , allselects[ea].value ) ; } 
            } }
    }
    
    var fdefarr=pobj[(w.name.replace("c_TA_","o_TA_"))];
    console.log(fdefarr); 
    
    var seriesInTarget= index2axisobj(targseridx+1).dat[0].length;
    console.log("seriesInTarget:",seriesInTarget);
    
    var outs=0;
    for (var e in fdefarr) {
        if (fdefarr[e].indexOf("$out")==-1) {
            //rimane da gestire gli in.
            
            if (fdefarr[e].indexOf("$in")==0) {
                if (fdefarr[e]=="$inReal" || fdefarr[e]=="$inClose") {  if (seriesInTarget>=4) { argarr.push(window.opener.Transpose(index2axisobj(targseridx+1).dat)[4]) } else { argarr.push(window.opener.Transpose(index2axisobj(targseridx+1).dat)[1]) }  } 
                if (fdefarr[e]=="$inOpen") {  if (seriesInTarget>=4) { argarr.push(window.opener.Transpose(index2axisobj(targseridx+1).dat)[1]) } else { argarr.push(window.opener.Transpose(index2axisobj(targseridx+1).dat)[1]) }  }
                if (fdefarr[e]=="$inHigh") {  if (seriesInTarget>=4) { argarr.push(window.opener.Transpose(index2axisobj(targseridx+1).dat)[2]) } else { argarr.push(window.opener.Transpose(index2axisobj(targseridx+1).dat)[1]) }  } 
                if (fdefarr[e]=="$inLow") {  if (seriesInTarget>=4) { argarr.push(window.opener.Transpose(index2axisobj(targseridx+1).dat)[3]) } else { argarr.push(window.opener.Transpose(index2axisobj(targseridx+1).dat)[1]) }  } 
            }


            if (fdefarr[e].indexOf("$optIn")>-1) {
                argarr.push(tapars[fdefarr[e]]);
            }
            
            
        }
        else { if (  (fdefarr[e].indexOf("$outBegIdx")==-1)    &&    (fdefarr[e].indexOf("$outNBElement")==-1)      )  {outs++;  }   }
    }
    
    console.log(argarr);
    NEWSERIESDATA=window.opener[funname].apply(this,argarr);
    if (outs == 1) {
        NEWDATAARRAY = window.opener.Transpose([giornis, NEWSERIESDATA]);
        defarr.push({dat:NEWDATAARRAY,nam:funname.replace("_f",""),index:destinationaxis});
        console.log(NEWDATAARRAY);
        window.location.reload(); // TODO: use addseries
    }
    else {
        console.log("more than one out, do something");
        console.log(NEWSERIESDATA);
        for (var ee in NEWSERIESDATA) {
            NEWDATAARRAY = window.opener.Transpose([giornis, NEWSERIESDATA[ee]]); 
            defarr.push({dat:NEWDATAARRAY,nam:funname.replace("_f","")+ee,index:destinationaxis});
            window.location.reload(); // this can prolly be avoided
        }
        // sticha giornis ad ognuno di essi ed adda ogni risultato come serie nuova sull√¨ index esistente
    }
    // NO DEVI CONTROLLARE QUANTI out ci sono , cosi' va bene solo per 1 out.. fai un for each su NEWSERIESDATA
    // sei fortunello solo BBANDS ha piu' di un output...
    // aggiungi NEWDATAARRAY alla chart, o in un nuovo asse o meno ma aggiungilo e poi chiama redraw
    }

chart1=new Highcharts.StockChart( {
    chart: {
        renderTo:'container'
    }
    , navigator : {
        enabled : false
    }
    , exporting: {
        buttons: {
            customButton: {
                x: -360, onclick: function() {
                    document.getElementById("optsdiv").style.display="block"; document.getElementById("container").style.display="none";
                    //alert('Clicked');
                }
                , symbol:'circle'
            }
        }
    },
    rangeSelector: {
        selected: 1
    }
    , series:defarr.map(dataDef)
    , yAxis : arrayUnique(defarr.map(indexDef))
}
);


function axes2menu() {
assi=chart1.axes.filter(function(x){return x.coll=="yAxis"});
window["vertpanesno"]=assi.length;
return ( "<option value='own' selected>Own</option>"+  assi.map(function(x){return ("<option value='"+x.axisTitle.textStr+"'>"+x.axisTitle.textStr+"</option>")}).join("")) 
}
window.amenutxt=axes2menu();
function series2menu() {
return ( chart1.series.map(function(x){return (x.index==0?"<option selected value='0'>"+x.name+"</option>":"<option value='"+x.index+"'>"+x.name+"</option>")}).join("")) 
}
window.smenutxt=series2menu();

index2axisobj=function(i){return (defarr.filter(function(x){return (x.index==i)})[0])     }
nam2axisobj=function(i){return (defarr.filter(function(x){return (x.nam==i)})[0])     }



</script>    
    
    
    
</body>
</html>


